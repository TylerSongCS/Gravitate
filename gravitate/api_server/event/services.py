from flask_restful import Resource

from gravitate.context import Context
from gravitate.domain.event.dao import EventDao
from gravitate.domain.event.models import Event, AirportEvent
from gravitate.models import Target
import gravitate.api_server.utils as service_utils
import gravitate.domain.event.actions as event_actions
from . import parsers as event_parsers
from gravitate.api_server import errors as service_errors
import warnings

from flask_restful import Resource

from gravitate.context import Context
import gravitate.api_server.utils as service_utils

db = Context.db


class EventCreation(Resource):
    @service_utils.authenticate
    def post(self, uid):
        """
                TODO: implement

                This method allows the user to post an event.
                    Expect a JSON form in request.json
                For now, handle only local time in "America/Los_Angeles"

                Form fields required:
                    "eventCategory": "campus" | "social"
                    "eventLocation" (A user-defined text description such as "LAX")
                    "locationRef" (Should have been generated by earlier steps in workflow)
                    "startLocalTime"
                    "endLocalTime"
                    "pricing": 100

                Validation:
                    Reject if:
                        eventCategory is "airport", or is not one of "campus", "social"
                        locationRef is the same as any airport locationRef
                        ...
                    Allow pricing to be empty, and fill in default value



                :param uid:
                :return:
                """
        raise NotImplementedError
        # Verify Firebase auth.
        user_id = uid

        event_dict = None

        eventCategory = args["eventCategory"]

        if eventCategory == "social":
            args = event_parsers.social_event_parser.parse_args()
            event_dict = args.values()
        else:
            raise Exception("Unsupported eventCategory: {}".format(eventCategory))

        print(args)

        # Create RideRequest Object
        event = event_actions.create(args, user_id, event_category=eventCategory)

        # rideRequest Response
        response_dict = {
            "id": event.get_firestore_ref().id
        }

        return response_dict, 200


class EventService(Resource):

    def get(self, eventId):
        event = EventDao().get_by_id(event_id=eventId)
        event_dict = {
            'eventCategory': event.event_category,
            'participants': event.participants,
            # 'eventLocation': self.event_location,
            # 'startTimestamp': self.start_timestamp,
            # 'endTimestamp': self.end_timestamp,
            # 'targets': event.targets,
            'pricing': event.pricing,
            # 'locationRef': event.location_ref,
            'isClosed': event.is_closed,
            'locationId': event.location_ref.id,
            'localDateString': event.local_date_string,
            'name': event.name,
            'description': event.description,
            'parkingInfo': event.parking_info
        }
        # print(event.to_dict())
        # print(event.targets)
        for target_dict in event.targets:
            # print(target_dict)
            target = Target.from_dict(target_dict)
            if target.to_event:
                event_dict["earliestArrival"] = target.get_earliest_arrival_view()
                event_dict["latestArrival"] = target.get_latest_arrival_view()
            else:
                event_dict["earliestDeparture"] = target.get_earliest_departure_view()
                event_dict["latestDeparture"] = target.get_latest_departure_view()
        if event.event_category == "airport":
            event_dict["airportCode"] = event.airport_code
        return event_dict
